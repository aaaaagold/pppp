<!DOCTYPE html>
<html>
<head>
<style>
.btn:hover{background-color:rgba(123,123,0,0.5);}
</style>
<script>
var AudioContext = window.AudioContext || window.webkitAudioContext;
let q={},d=document;
q.ce=function(h){return d.createElement(h);};
q.ge=function(i){return d.getElementById(i);};
Array.prototype.back=function(){return this.length==0?undefined:this[this.length-1];};
HTMLElement.prototype.ac=function(c){this.appendChild(c); return this;};
HTMLElement.prototype.ga=function(a){return this.getAttribute(a);};
HTMLElement.prototype.sa=function(a,v){this.setAttribute(a,v);return this;};
HTMLElement.prototype.at=function(t){this.ac(d.createTextNode(t));return this;};
HTMLElement.prototype.ra=function(n){let arr=this.childNodes;while(arr.length!=0&&arr.length>n)this.removeChild(arr[arr.length-1]);return this;};
</script>
</head>
<body>
<div id="root"><div id="keys"></div><div>currPitchDelta <input id="currPitchDelta" type=number value=0></div><div id="btns"></div><div id="rec">[]</div></div>
<script>
const baseTime=new Date().getTime();
// divs
const currPitchDelta=q.ge("currPitchDelta");
// divs end
//const keys=['A','S','E','D','R','F','G','Y','H','U','J','I','K','L']; // until ver. @ 2019/11/04
const keys=[
	'Z','X','D','C','F','Q','2','W', // Mi ... Si
	'E','4','R','5','T','Y','7','U','8','I','9','O','P', // Do ... Do
	189,'V','G','B','N','J','M','K', // Do# ...
]; // dev.er setting
const Hz440id=keys.indexOf('I'); // dev.er setting
const keysOri=[]; for(let x=0;x!==keys.length;++x) keysOri[x]=keys[x];
	for(let x=keys.length;x--;) if(typeof keys[x]==="string") keys[x]=keys[x].charCodeAt();
const keysDown=[]; keysDown.length=keys.length;
const keysRecover=[]; keysRecover.length=keys.length;
const freqs=[]; for(let x=0;x<keys.length;++x) freqs.push(Math.pow(2,(x-Hz440id)/12.0)*440);
freqs.delta=0;
currPitchDelta.onchange=()=>{
	let tmp=currPitchDelta.value.match(/-?[0-9]+/);
	if(tmp!==null) freqs.change_to(parseInt(tmp[0]));
};
freqs._change_common=()=>{
	oscillators.reset();
	currPitchDelta.ra(0).at(""+freqs.delta);
};
freqs.change_to=(n)=>{ freqs.delta=n; freqs._change_common(); };
freqs.change_delta=(n)=>{ freqs.delta+=n; freqs._change_common(); };
console.log(freqs[Hz440id]); // debug

let audioCtxs = [];
let gainNodes = [];
let oscillators = [];
	oscillators.reset=()=>{
		let r=Math.pow(2,freqs.delta/12.0);
		for(let x=0;x!==oscillators.length;++x){
			let oscillator = new OscillatorNode(audioCtxs[x],{detune:0,frequency:freqs[x]*r,type:"triangle"});
			oscillator.start(0);
			oscillators[x].disconnect(gainNodes[x]);
			oscillator.connect(gainNodes[x]);
			oscillators[x]=oscillator;
		}
	};
for(let x=0;x!==keys.length;++x){
	let audioCtx = new AudioContext();
	audioCtxs.push(audioCtx);
	let gainNode = new GainNode(audioCtx,{gain:0});
	gainNode.connect(audioCtx.destination);
	gainNodes.push(gainNode);
	let oscillator = new OscillatorNode(audioCtx,{detune:0,frequency:freqs[x],type:"triangle"});
	oscillator.connect(gainNode);
	oscillators.push(oscillator);
}
for(let x=0;x!==oscillators.length;++x) oscillators[x].start(0);

let keydown=(id)=>{
	let alreadyDown=keysDown[id];
	keysDown[id]=1;
	
	if(audioCtxs[id].state==="suspended") audioCtxs[id].resume();
	if(keysRecover[id]){ clearInterval(keysRecover[id]); keysRecover[id]=0; }
	if(!alreadyDown){
		gainNodes[id].gain.value=1;
		seq.push([id-Hz440id,"down",new Date().getTime()-baseTime]);
	}
};
let keyup=(id)=>{
	keysDown[id]=0;
	
	//gainNodes[id].gain.value=0;
	let itvl=setInterval(function(){
		let val=gainNodes[id].gain.value;
		//val-=0.0078125;
		val*=0.984375;
		if(val<1e-4){ keysRecover[id]=0; val=0; clearInterval(itvl); }
		if(!keysDown[id]) gainNodes[id].gain.value=val;
	},1);
	keysRecover[id]=itvl;
	seq.push([id-Hz440id,"up",new Date().getTime()-baseTime]);
};

let seq=[];
let seqs=[]; // array of seq, appended when clear
let stopseq=1;
let queuingseq={},queuingseq_serial=0;
let playseq=(seq)=>{
	stopseq&=0;
	let baseTime=seq[0][2],basefoo=()=>{};
	let playone=(kid,upordown)=>{
		if(stopseq) return;
		let foo=basefoo;
		if(upordown==="down") foo=keydown;
		if(upordown==="up") foo=keyup;
		foo(kid);
	};
	let prepare=(sid,baseTime)=>{
		if(stopseq) return;
		if(sid===seq.length){ console.log("seq end"); return; }
		let nextTime=(("string"===typeof seq[sid][2])&&seq[sid][2][0]==="+")?parseInt(seq[sid][2]):(seq[sid][2]-baseTime);
		let kid=seq[sid][0]+Hz440id;
		let upordown=seq[sid][1];
		let serial=queuingseq_serial; ++queuingseq_serial; queuingseq_serial&=0xffff;
		let x=setTimeout(()=>{
			delete queuingseq[serial];
			playone(kid,upordown);
			prepare(sid+1,baseTime+nextTime);
		},nextTime);
		queuingseq[serial]=x;
	};
	prepare(0,baseTime);
};

document.body.addEventListener('keydown',(evt)=>{
	//if(evt.isComposing){return;}
	let key=evt.keyCode;
	let id=keys.indexOf(key);
	if(id===-1){
		// alt functions
		switch(key)
		{
		default:
			break;
		// pitch higher / lower
		case 38:
			freqs.change_delta(1);
			currPitchDelta.value=parseInt(currPitchDelta.value)+1;
			break;
		case 40:
			freqs.change_delta(-1);
			currPitchDelta.value=parseInt(currPitchDelta.value)-1;
			break;
		}
		return;
	}
	
	keydown(id);
});
document.body.addEventListener('keyup',(evt)=>{
	//if(evt.isComposing){return;}
	let key=evt.keyCode;
	let id=keys.indexOf(key);
	if(id===-1){
		return;
	}
	
	keyup(id);
});
q.ge("keys").at(JSON.stringify(keysOri));
q.ge("btns").ac(
	(()=>{
		let div=q.ce("div").sa("class","btn").at("input and play record");
		div.onclick=()=>{
			let rec=prompt("paste your record below");
			if(rec!==null) playseq(JSON.parse(rec));
		};
		return div;
	})()
).ac(
	(()=>{
		let div=q.ce("div").sa("class","btn").at("stop playing record");
		div.onclick=()=>{
			stopseq|=1;
			for(let x=0;x!==keysDown.length;++x) if(keysDown[x]) keyup(x);
			for(let i in queuingseq) clearTimeout(queuingseq[i]);
		};
		return div;
	})()
).ac(
	(()=>{
		let div=q.ce("div").sa("class","btn").at("clear record");
		div.onclick=()=>{seqs.push(seq);seq=[];};
		return div;
	})()
).ac(
	(()=>{
		let div=q.ce("div").sa("class","btn").at("update record");
		div.onclick=()=>{q.ge("rec").ra(0).at(JSON.stringify(seq))};
		return div;
	})()
).ac(
	(()=>{
		let div=q.ce("div").sa("class","btn").at("update record (delta timing)");
		div.onclick=()=>{
			if(!seq.length) return;
			let output=[[seq[0][0],seq[0][1],0]];
			for(let x=1;x!==seq.length;++x) output.push([seq[x][0],seq[x][1],"+"+(seq[x][2]-seq[x-1][2])]);
			q.ge("rec").ra(0).at(JSON.stringify(output));
		};
		return div;
	})()
);
</script>
</body>
</html>
