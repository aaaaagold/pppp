<!DOCTYPE html>
<html>
<head>
<style>
.btn:hover{background-color:rgba(123,123,0,0.5);}
.inaline>*{display:inline-block;}
.sparse22>*{margin:22px;}
</style>
<script>
var AudioContext = window.AudioContext || window.webkitAudioContext;
let q={},d=document;
q.ce=function(h){return d.createElement(h);};
q.ge=function(i){return d.getElementById(i);};
Array.prototype.back=function(){return this.length==0?undefined:this[this.length-1];};
HTMLElement.prototype.ac=function(c){this.appendChild(c); return this;};
HTMLElement.prototype.ga=function(a){return this.getAttribute(a);};
HTMLElement.prototype.sa=function(a,v){this.setAttribute(a,v);return this;};
HTMLElement.prototype.at=function(t){this.ac(d.createTextNode(t));return this;};
HTMLElement.prototype.ra=function(n){let arr=this.childNodes;while(arr.length!=0&&arr.length>n)this.removeChild(arr[arr.length-1]);return this;};
</script>
</head>
<body>
<div id="root"><div id="keys"></div><div>currPitchDelta <input id="currPitchDelta" type=number value=0></div><div id="btns" class="sparse22"></div><div id="rec">[]</div></div>
<script src="prepare.js"></script>
<script src="rnd.js"></script>
<script>
document.body.addEventListener('keydown',io_keydown);
document.body.addEventListener('keyup',io_keyup);

q.ge("keys").at(JSON.stringify(keysOri));
q.ge("btns").ac(
	(()=>{
		let div=q.ce("div").sa("class","btn").at("input and play record");
		div.onclick=()=>{
			let rec=prompt("paste your record below");
			lastInput=JSON.parse(rec);
			if(rec!==null) playseq(lastInput);
		};
		return div;
	})()
).ac(
	(()=>{
		let div=q.ce("div").sa("class","btn").at("stop playing record");
		div.onclick=()=>{playseq.stop();};
		return div;
	})()
).ac(
	(()=>{
		let div=q.ce("div").sa("class","btn").at("replay last input record");
		div.onclick=()=>{playseq(lastInput);};
		return div;
	})()
).ac(
	(()=>{
		let div=q.ce("div").sa("class","btn").at("clear record");
		div.onclick=()=>{seqs.push(seq);seq=[];};
		return div;
	})()
).ac(
	(()=>{
		let div=q.ce("div").sa("class","btn").at("update record");
		div.onclick=()=>{putseq(q.ge("rec"),seq);};
		return div;
	})()
).ac(
	(()=>{
		let div=q.ce("div").sa("class","btn").at("update record (time from 0)");
		div.onclick=()=>{putseq(q.ge("rec"),seq_dlt2abs(seq_abs2dlt(seq),0));};
		return div;
	})()
).ac(
	(()=>{
		let div=q.ce("div").sa("class","btn").at("update record (delta timing)");
		div.onclick=()=>{putseq(q.ge("rec"),seq_abs2dlt(seq));};
		return div;
	})()
).ac(
	(()=>{
		let div=q.ce("div").sa("class","btn").at("random"),cnt=q.ce("input").sa("type","number").sa("value","300"),delay=q.ce("input").sa("type","number").sa("value","100");
		let base=q.ce("div").sa("class","btn").at("random a base");
		let mega=q.ce("div").sa("class","btn").at("random with base");
		let last_rpl=q.ce("div").sa("class","btn").at("replay last random");
		let last_abs=q.ce("div").sa("class","btn").at("update last random");
		let last_abs0=q.ce("div").sa("class","btn").at("update last random (time from 0)");
		let last_dlt=q.ce("div").sa("class","btn").at("update last random (delta timing)");
		let last_base_rpl=q.ce("div").sa("class","btn").at("replay last base");
		let last_base_dlt=q.ce("div").sa("class","btn").at("update last base (delta timing)");
		let last_mega_rpl=q.ce("div").sa("class","btn").at("replay last 'random with base'");
		let last_mega_dlt=q.ce("div").sa("class","btn").at("update last 'random with base' (delta timing)");
		div.last_seq=[];
		div.genseq=()=>{
			let rtv={};
			let at_time=new Date().getTime()-baseTime;
			let seq=rnd(parseInt(cnt.value),Number(delay.value));
			rtv.last_seq=seq;
			rtv.last_seq.at_time=at_time;
			return rtv.last_seq;
		};
		div.onclick=()=>{
			playseq.stop();
			playseq((div.last_seq=div.genseq()));
			// ----
			arr=div.last_seq;
			console.log(JSON.stringify(arr));
			// ----
			//arr2=arr.concat(shift(arr,6)).concat(arr);//.concat(shift(arr,-12));
			//console.log(JSON.stringify(arr2));
		};
		last_rpl.onclick=()=>{playseq.stop();playseq(div.last_seq);};
		last_abs.onclick=()=>{putseq(q.ge("rec"),seq_dlt2abs(div.last_seq,div.last_time));};
		last_abs0.onclick=()=>{putseq(q.ge("rec"),seq_dlt2abs(div.last_seq,0));};
		last_dlt.onclick=()=>{putseq(q.ge("rec"),div.last_seq);};
		base.last_seq=[];
		base.genseq=()=>{
			let rtv={};
			let delays=[50]; for(let x=1;x<11;++x) delays.push(x*100);
			let clip_min=((parseInt(Math.random()*freqs.length)+0)>>1)-Hz440id;
			let clip_max=((parseInt(Math.random()*freqs.length)+freqs.length)>>1)-Hz440id;
			if(clip_max<clip_min){let tmp=clip_max; clip_max=clip_min; clip_min=tmp;}
			let clip=[clip_min,clip_max];
			let delay_=delays[parseInt(Math.random()*delays.length)];
			let cnt_=parseInt(cnt.value)*delay.value; cnt_=parseInt(cnt_/delay_)+(cnt_%delay_!==0);
			rtv.last_seq=rnd(cnt_,delay_,clip);
			rtv.last_seq.clip=clip;
			rtv.last_seq.cnt=cnt_;
			rtv.last_seq.delay=delay_;
			console.log(rtv.last_seq);
			return rtv.last_seq;
		};
		base.onclick=()=>{
			playseq.stop();
			playseq(base.last_seq=base.genseq());
		};
		last_base_rpl.onclick=()=>{playseq.stop();playseq(base.last_seq);};
		last_base_dlt.onclick=()=>{putseq(q.ge("rec"),base.last_seq);};
		mega.last_seq=[];
		mega.genseq=(base_count)=>{
			if(!base_count || base_count<0) base_count=2;
			let rtv={};
			rtv.bases={}; for(let x=0;x<base_count;++x) rtv.bases[x]=base.genseq();
			rtv.main=div.genseq();
			return rtv;
		};
		mega.play=(megaseq)=>{
			for(let x in megaseq.bases) playseq(megaseq.bases[x]);
			playseq(megaseq.main);
		};
		mega.onclick=()=>{
			playseq.stop();
			mega.play(mega.last_seq=mega.genseq());
		};
		last_mega_rpl.onclick=()=>{playseq.stop();mega.play(mega.last_seq);};
		last_mega_dlt.onclick=()=>{putseq(q.ge("rec"),mega.last_seq);};
		return q.ce("div").ac(div).ac(
				q.ce("div").at(" count ").ac(cnt).at(" delay ").ac(delay)
			).ac(last_rpl).ac(last_abs).ac(last_abs0).ac(last_dlt).
			ac(base).ac(last_base_rpl).ac(last_base_dlt).
			ac(mega).ac(last_mega_rpl).ac(last_mega_dlt);
	})()
);
</script>
</body>
</html>
